---
image: docker:stable
services:
  - docker:dind

stages:
  - check_images
  - build
  - containerization
  - quality

build_docker_images:
  stage: check_images
  needs:
    pipeline: FrancoisSevestre/dockerfiles

compilation_job:
  stage: build
  script:
    - docker run
        --volume "$PWD:/code"
        registry.gitlab.com/francoissevestre/dockerfiles/cmake
    - echo "Job-> CI_JOB_NAME, Stage-> $CI_JOB_STAGE" >> report.md
    - echo "Compilation done with CMake" >> report.md
  artifacts:
    paths:
      - cninjatodola

code_quality_job:
  stage: quality
  allow_failure: true
  script:
    - mkdir codequality-results
    - docker run
        --env CODECLIMATE_CODE="$PWD"
        --volume "$PWD"/src:/code
        --volume /var/run/docker.sock:/var/run/docker.sock
        --volume /tmp/cc:/tmp/cc
        codeclimate/codeclimate analyze -f html
        > ./codequality-results/index.html
    - echo "Job-> CI_JOB_NAME, Stage-> $CI_JOB_STAGE" >> report.md
    - echo "Code complexity mesured with codeclimate" >> report.md
  artifacts:
    paths:
      - codequality-results/

code_linting_job:
  stage: quality
  allow_failure: true
  script:
    - docker run
        --volume "$PWD"/src:/code
        registry.gitlab.com/francoissevestre/dockerfiles/cpplint > errors
        || echo "done"
    - echo "Job-> CI_JOB_NAME, Stage-> $CI_JOB_STAGE" >> report.md
    - echo "Code linting performed with cpplint" >> report.md
  artifacts:
    paths:
      - src/linting_results

containerization_job:
  needs: ["compilation_job"]
  stage: containerization
  before_script:
    - echo $CI_BUILD_TOKEN |
      docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/cninjatodola-archlinux" .
    - docker push "$CI_REGISTRY_IMAGE/cninjatodola-archlinux"
    - echo "Job-> CI_JOB_NAME, Stage-> $CI_JOB_STAGE" >> report.md
    - echo "Docker image pushed to Gitlab registry" >> report.md

push_to_dockerhub_job:
  needs: ["compilation_job"]
  stage: containerization
  before_script:
    - echo "pushing image to $DOCKERHUB_USERNAME/cninjatodola-archlinux on hub"
    - echo "$DOCKERHUB_TOKEN" |
      docker login --username "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - docker build -t "$DOCKERHUB_USERNAME/cninjatodola-archlinux" .
    - docker push "$DOCKERHUB_USERNAME/cninjatodola-archlinux"
    - echo "Job-> CI_JOB_NAME, Stage-> $CI_JOB_STAGE" >> report.md
    - echo "Docker image pushed to dockerhub registry" >> report.md

building_report_job:
  stage: .pre
  script: |
     cat > report.md << EOF
     # CninjaTODOla CI/CD pipeline report
     Creation date: $CI_JOB_STARTED_AT
  artifacts:
    paths:
      - report.md
